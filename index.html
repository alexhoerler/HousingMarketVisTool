<!DOCTYPE html>

<head>
    <title>Housing Market Across the U.S.</title>
    <meta charset="utf-8">
    <script type="text/javascript" src="lib/d3.v5.min.js"></script>
    <script type="text/javascript" src="lib/d3-dsv.min.js"></script>
    <script src="lib/d3-tip.min.js"></script>
    <script src="lib/topojson.v2.min.js"></script>
    <style>
        body {
            background-color: #d3d3d3;
            margin: 0;
            padding: 0;
        }

        .header {
            background-color: #ffffff;
            color: #000000;
            padding: 25px;
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
        }

        body>*:not(.header) {
            margin: 25px;
        }

        .mapPath {
            fill: #ccc;
            stroke: #ffffff;
            stroke-width: 1px;
        }

        path {
            fill: #ffffff;
            stroke: #000000;
            stroke-width: 1px;
        }

        .container {
            display: flex;
            flex-direction: row;
        }

        svg {
            background-color: #ffffff;
            margin: 0;
            padding: 0;
        }

        .solidUnder {
            text-decoration: underline;
        }

        .underline {
            stroke: black;
            stroke-width: 2;
            stroke-dasharray: 3, 3;
        }
    </style>
</head>

<body>
    <div class="header" id="header">
        <h1>The Housing Market Across the States</h1>
    </div>
    <div class="mapContainer" id="mapContainer">
    </div>
    <div class="graphContainer" id="graphContainer">
    </div>

    <script>

        map_width = 975 / 2;
        map_height = 610 / 2;
        let margin = { left: 40, right: 40, top: 40, bottom: 40 };

        let svg = d3.select("#mapContainer")
            .append("svg")
            .attr("id", "map")
            .attr("width", map_width)
            .attr("height", map_height);

        Promise.all([
            d3.csv("data/data.csv"),
            d3.csv("data/state_avg_ppsf.csv"),
            d3.json("data/UsStates.json")
        ]).then(function (state_data_files) {
            var generalData = state_data_files[0]
            var state_ppsf = state_data_files[1]
            var usStates = state_data_files[2];
            console.log(state_ppsf)
            console.log(usStates);

            const scaleFunction = d3.geoTransform({
                point: function (x, y) {
                    this.stream.point(x / 2, y / 2);
                }
            });

            // Define a path generator with scaled projection
            const path = d3.geoPath().projection(scaleFunction);

            const state = svg.append("g")
                .attr("stroke", "#444")
                .attr("fill", "#eee")
                .selectAll("path")
                .data(topojson.feature(usStates, usStates.objects.states).features)
                .enter().append("path")
                .attr("d", path)
                .attr("class", "mapPath");

            createPpsfLine("North Carolina");

            /* Create ppsf Line */
            function createPpsfLine(state) {
                let data = [];
                let predicted = [];
                state_ppsf.forEach(function (state_data) {
                    if (state_data.state == state) {
                        for (const [key, value] of Object.entries(state_data)) {
                            if (key != "state") {
                                const datapoint = { x: parseInt(key), y: +value };
                                data.push(datapoint);
                            }
                            if (key != "state" && key > 2020) {
                                const datapoint = { x: parseInt(key), y: +value };
                                predicted.push(datapoint);
                            }
                        }
                    }
                });

                let ppsf_svg = d3.select("#graphContainer")
                    .append("svg")
                    .attr("id", "ppsf_map")
                    .attr("width", map_width)
                    .attr("height", map_height);

                let ppsf_graph = ppsf_svg.append("g")
                    .attr("id", "ppsf_graph");

                const xScale = d3.scaleLinear()
                    .domain(d3.extent(data, d => d.x))
                    .range([margin.left, map_width - margin.right]);

                const yScale = d3.scaleLinear()
                    .domain([0, d3.max(data, d => d.y)])
                    .range([map_height, margin.bottom * 2]);

                const line = d3.line()
                    .x(d => xScale(d.x))
                    .y(d => yScale(d.y))
                    .curve(d3.curveCatmullRom);

                data = data.slice(0, -3);

                ppsf_graph.append("path")
                    .datum(data)
                    .attr("fill", "none")
                    .attr("stroke", "black")
                    .attr("stroke-width", 2)
                    .attr("class", "lineExist")
                    .attr("d", line);

                ppsf_graph.append("path")
                    .datum(predicted)
                    .attr("fill", "none")
                    .attr("stroke", "black")
                    .attr("stroke-width", 2)
                    .style("stroke-dasharray", ("3, 3"))
                    .attr("class", "linePredict")
                    .attr("d", line);

                ppsf_svg.append("text")
                    .attr("id", "ppsf_title1")
                    .attr("x", map_width / 2 - 145)
                    .attr("y", margin.top)
                    .attr("text-anchor", "middle")
                    .attr("class", "solidUnder")
                    .style("font-size", 20)
                    .text("Past");

                ppsf_svg.append("line")
                    .attr("id", "underline")
                    .attr("x1", "154")
                    .attr("y1", "42")
                    .attr("x2", "232")
                    .attr("y2", "42")
                    .attr("class", "underline");

                ppsf_svg.append("text")
                    .attr("id", "ppsf_title1")
                    .attr("x", map_width / 2 + 30)
                    .attr("y", margin.top)
                    .attr("text-anchor", "middle")
                    .style("font-size", 20)
                    .text(" and Predicted PPSF of " + state);

                var x_axis = ppsf_svg.append("g")
                    .attr("id", "x-axis")
                    .attr("transform", "translate(0," + (map_height - margin.bottom) + ")")
                x_axis.call(d3.axisBottom(xScale));
                ppsf_svg.append("text")
                    .attr("id", "x-label")
                    .attr("x", map_width / 2)
                    .attr("y", map_height - margin.bottom / 4)
                    .attr("text-anchor", "middle")
                    .style("fill", "black")
                    .style("font-size", 14)
                    .text("Year");

                var y_axis = ppsf_svg.append("g")
                    .attr("id", "y-axis")
                    .attr("transform", "translate(" + (margin.left) + ", " + (- margin.bottom) + ")")
                    .style("stroke-width", "1px");
                y_axis.call(d3.axisLeft(yScale).tickFormat(d => (d / 1000)));
                ppsf_svg.append("text")
                    .attr("id", "y-label")
                    .attr("transform", "rotate(-90)")
                    .attr("x", - map_height / 2)
                    .attr("y", 0)
                    .attr("dy", "1em")
                    .attr("text-anchor", "middle")
                    .style("fill", "black")
                    .style("font-size", 14)
                    .text("Avg. Price/Square Foot (k)");
            }

        }).catch(function (error) {
            console.log(error);
        });
    </script>
</body>